<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>0x1 App</title>
  <link rel="stylesheet" href="/styles/tailwind.css">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  
  <!-- Import Map for bare imports - enables importing directly from '0x1' -->
  <script type="importmap">
  {
    "imports": {
      "0x1": "/node_modules/0x1/index.js",
      "0x1/": "/node_modules/0x1/"
    }
  }
  </script>
</head>
<body>
  <!-- App Container - The app directory components from router.ts will render here -->
  <div id="app"></div>

  <!-- Router implementation - directly included to avoid import issues -->
  <script type="module">
    // 0x1 Router implementation
    window.Router = class Router {
      constructor(options) {
        this.rootElement = options.root;
        this.mode = options.mode || 'history';
        this.routes = new Map();
        this.basePath = options.basePath || '';
        this.notFoundComponent = options.notFoundComponent;
        this.transitionDuration = options.transitionDuration || 200;
        this.currentComponent = null;
        
        console.log('[Router] Initialized with mode:', this.mode);

        // Initialize router based on mode
        if (this.mode === 'history') {
          window.addEventListener('popstate', () => this.handleRouteChange());
        } else {
          window.addEventListener('hashchange', () => this.handleRouteChange());
        }

        // Initial route rendering
        setTimeout(() => this.handleRouteChange(), 0);
      }

      // Add a route to the router
      add(path, component) {
        console.log('[Router] Adding route:', path);
        this.routes.set(path, component);
        return this;
      }

      // Alias for add method for compatibility
      addRoute(path, component) {
        return this.add(path, component);
      }

      // Get the current path based on routing mode
      getCurrentPath() {
        let path;
        if (this.mode === 'history') {
          // Ensure we normalize empty paths to / for the root path
          path = window.location.pathname.replace(this.basePath, '');
          if (path === '') path = '/';
        } else {
          // For hash mode also normalize to /
          path = window.location.hash.slice(1) || '/';
        }
        console.log('[Router] Current path:', path);
        return path;
      }

      // Handle route changes
      handleRouteChange() {
        console.log('[Router] Handling route change');
        const path = this.getCurrentPath();
        console.log('[Router] Available routes:', [...this.routes.keys()]);
        let component = this.routes.get(path);
        
        // Debug logging for route matching
        if (component) {
          console.log('[Router] Found component for path:', path);
        } else {
          console.log('[Router] No component found for path:', path);
          if (this.notFoundComponent) {
            console.log('[Router] Using notFoundComponent');
            component = this.notFoundComponent;
          } else {
            console.log('[Router] No notFoundComponent provided, showing error message');
            this.rootElement.innerHTML = `<div>Page not found: ${path}</div>`;
            return;
          }
        }

        // Render the component
        this.renderComponent(component);
      }

      // Render a component with transition
      renderComponent(component) {
        // Apply transition effect if previous component exists
        if (this.currentComponent) {
          this.rootElement.style.opacity = '0';
          
          setTimeout(() => {
            // Clear previous content
            this.rootElement.innerHTML = '';
            
            // Create and append new element
            const el = component.render();
            this.rootElement.appendChild(el);
            
            // Call onMount if available
            if (component.onMount) {
              component.onMount(el);
            }
            
            // Store current component
            this.currentComponent = component;
            
            // Restore visibility
            this.rootElement.style.opacity = '1';
          }, this.transitionDuration);
        } else {
          // First render, no transition needed
          const el = component.render();
          this.rootElement.appendChild(el);
          
          if (component.onMount) {
            component.onMount(el);
          }
          
          this.currentComponent = component;
        }
      }

      // Navigate to a new route
      navigate(path) {
        if (this.mode === 'history') {
          history.pushState(null, '', this.basePath + path);
          this.handleRouteChange();
        } else {
          window.location.hash = path;
        }
      }

      // Go back in history
      back() {
        window.history.back();
      }

      // Go forward in history
      forward() {
        window.history.forward();
      }
    };

    // Also expose Link and NavLink classes for consistency
    window.Link = class Link {
      constructor(options) {
        this.to = options.to;
        this.text = options.text;
        this.className = options.className || '';
      }
      
      render() {
        const link = document.createElement('a');
        link.href = this.to;
        link.className = this.className;
        link.textContent = this.text;
        return link;
      }
    };

    window.NavLink = class NavLink extends window.Link {
      constructor(options) {
        super(options);
        this.activeClass = options.activeClass || 'active';
      }
    };

    window.Redirect = class Redirect {
      constructor(options) {
        this.to = options.to;
      }
      
      render() {
        const div = document.createElement('div');
        div.style.display = 'none';
        
        // Redirect after render
        setTimeout(() => {
          window.location.href = this.to;
        }, 0);
        
        return div;
      }
    };
  </script>

  <!-- Script built with bun -->
  <script type="module" src="/index.js"></script>
</body>
</html>
