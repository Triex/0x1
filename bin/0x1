#!/bin/sh

# 0x1 CLI Entry Point - Ultra-simple direct execution strategy
# This script ensures proper execution of the 0x1 CLI across all platforms

# Prevent recursive execution
if [ "$OX1_RUNNING" = "1" ]; then
  echo "Error: Recursion detected in 0x1 CLI execution" >&2
  exit 1
fi
export OX1_RUNNING=1

# Define paths - we need to find both the CLI script and the bun executable
HOME_DIR="$HOME"
BUN_BIN="$HOME_DIR/.bun/bin/bun"
NODE_MODULES="$HOME_DIR/.bun/install/global/node_modules"
CLI_MAIN="$NODE_MODULES/0x1/dist/cli/index.js"
DEV_CLI="$(dirname "$0")/../dist/cli/index.js"

# Check for development version
if [ -f "$DEV_CLI" ]; then
  CLI_MAIN="$DEV_CLI"
fi

# IMPORTANT: The CLI must be run with bun since it contains Bun-specific code
# Try different strategies in order of preference

# 1. Direct bun binary execution - most reliable
if [ -f "$BUN_BIN" ] && [ -f "$CLI_MAIN" ]; then
  exec "$BUN_BIN" "$CLI_MAIN" "$@"
  
# 2. Use bunx directly 
elif command -v bunx >/dev/null 2>&1; then
  exec bunx 0x1 "$@"
  
# 3. Use PATH-based bun if available
elif command -v bun >/dev/null 2>&1; then
  if [ -f "$CLI_MAIN" ]; then
    exec bun "$CLI_MAIN" "$@"
  else
    exec bun x 0x1 "$@"
  fi

# 4. As a last resort, try to use bunx
else
  echo "Error: Unable to execute 0x1 CLI" >&2
  echo "" >&2
  echo "Please ensure Bun is installed properly:" >&2
  echo "  1. Install Bun: curl -fsSL https://bun.sh/install | bash" >&2
  echo "  2. Add Bun to your PATH:" >&2
  echo "     export BUN_INSTALL=\"$HOME/.bun\"" >&2
  echo "     export PATH=\"\$BUN_INSTALL/bin:\$PATH\"" >&2
  echo "" >&2
  echo "  For more details, see: https://bun.sh/docs/installation" >&2
  exit 1
fi
